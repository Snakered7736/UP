<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ФК Анжил — Оформление заказа</title>

<style>
/* ================= ROOT ================= */
:root{
  --orange:#ff8a00;
  --dark:#222;
  --muted:#f3f3f3;
  --red:#d61b1b;
  --card:#2b2b2b;
  --max:1200px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,Arial,Helvetica,sans-serif;
  background:#111;
  color:#fff;
}
a{
  color:inherit;
  text-decoration:none;
}

/* ================= CHECKOUT LAYOUT ================= */
.checkout-container{
  display:grid;
  grid-template-columns:1fr 1fr;
  min-height:100vh;
}

/* ================= LEFT COLUMN (FORM) ================= */
.checkout-left{
  background:var(--card);
  padding:60px 80px;
  display:flex;
  flex-direction:column;
}

.logo-link{
  display:inline-block;
  margin-bottom:40px;
}

.logo-link img{
  height:60px;
}

.checkout-title{
  font-size:32px;
  margin:0 0 40px;
  letter-spacing:1px;
}

.form-group{
  margin-bottom:24px;
}

.form-input{
  width:100%;
  padding:14px 16px;
  font-size:16px;
  border:1px solid #444;
  background:#1a1a1a;
  color:#fff;
  border-radius:4px;
  font-family:inherit;
}

.form-input::placeholder{
  color:#666;
}

.form-input:focus{
  outline:none;
  border-color:var(--orange);
}

.form-input:focus::placeholder{
  color:#fff;
}

.btn-submit{
  width:100%;
  padding:16px;
  font-size:18px;
  font-weight:700;
  background:var(--red);
  color:#fff;
  border:none;
  border-radius:4px;
  cursor:pointer;
  margin-top:16px;
  transition:background .2s;
}

.btn-submit:hover{
  background:#c01717;
}

.success-message{
  display:none;
  margin-top:20px;
  padding:16px;
  background:#28a745;
  border-radius:4px;
  text-align:center;
}

.success-message.show{
  display:block;
}

/* ================= RIGHT COLUMN (ORDER SUMMARY) ================= */
.checkout-right{
  background:var(--orange);
  padding:60px 80px;
}

.order-title{
  font-size:28px;
  margin:0 0 30px;
  letter-spacing:1px;
}

.order-items{
  margin-bottom:30px;
}

.order-item{
  background:rgba(0,0,0,0.15);
  border-radius:8px;
  padding:16px;
  margin-bottom:16px;
  display:flex;
  gap:16px;
  align-items:center;
}

.item-image{
  width:80px;
  height:80px;
  object-fit:contain;
  border-radius:4px;
  background:#fff;
}

.item-details{
  flex:1;
}

.item-name{
  font-size:18px;
  font-weight:700;
  margin:0 0 8px;
}

.item-info{
  font-size:14px;
  opacity:0.9;
}

.order-summary-block{
  background:rgba(0,0,0,0.15);
  border-radius:8px;
  padding:20px;
}

.summary-row{
  display:flex;
  justify-content:space-between;
  margin-bottom:12px;
  font-size:16px;
}

.summary-row.total{
  font-size:24px;
  font-weight:700;
  border-top:2px solid rgba(0,0,0,0.2);
  padding-top:12px;
  margin-top:12px;
}

.empty-cart{
  text-align:center;
  padding:40px;
  opacity:0.7;
}
</style>

</head>
<body>

<div class="checkout-container">
  <!-- ================= LEFT COLUMN: FORM ================= -->
  <div class="checkout-left">
    <a href="index.html" class="logo-link">
      <img src="images/v1_195.png" alt="ФК Анжил">
    </a>

    <h1 class="checkout-title">Оформление заказа</h1>

    <form id="checkoutForm">
      <div class="form-group">
        <input
          type="text"
          id="fullName"
          class="form-input"
          placeholder="ФИО"
          required
        >
      </div>

      <div class="form-group">
        <input
          type="text"
          id="city"
          class="form-input"
          placeholder="Город"
          required
        >
      </div>

      <div class="form-group">
        <input
          type="email"
          id="email"
          class="form-input"
          placeholder="E-mail"
          required
        >
      </div>

      <div class="form-group">
        <input
          type="text"
          id="address"
          class="form-input"
          placeholder="Адрес"
          required
        >
      </div>

      <div class="form-group">
        <input
          type="tel"
          id="phone"
          class="form-input"
          placeholder="Телефон"
          required
        >
      </div>

      <div class="form-group">
        <input
          type="text"
          id="zipCode"
          class="form-input"
          placeholder="Индекс"
          required
        >
      </div>

      <button type="submit" class="btn-submit">Оформить заказ</button>
    </form>

    <div id="successMessage" class="success-message">
      ✓ Заказ успешно оформлен! Мы свяжемся с вами в ближайшее время.
    </div>
  </div>

  <!-- ================= RIGHT COLUMN: ORDER SUMMARY ================= -->
  <div class="checkout-right">
    <h2 class="order-title">Ваш заказ</h2>

    <div id="orderItemsContainer" class="order-items">
      <!-- Товары будут загружены из корзины через JavaScript -->
    </div>

    <div class="order-summary-block">
      <div class="summary-row">
        <span>Сумма товаров:</span>
        <span id="subtotal">0 ₽</span>
      </div>

      <div class="summary-row">
        <span>Скидка (10%):</span>
        <span id="discount">0 ₽</span>
      </div>

      <div class="summary-row total">
        <span>Итого к оплате:</span>
        <span id="total">0 ₽</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= CART LOADING & CALCULATION ================= */
function loadCart() {
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const container = document.getElementById('orderItemsContainer');

  if (cart.length === 0) {
    container.innerHTML = '<div class="empty-cart">Корзина пуста</div>';
    updateSummary(0, 0, 0);
    return;
  }

  // Рендерим товары
  container.innerHTML = cart.map(item => `
    <div class="order-item">
      <img src="${item.image}" alt="${item.name}" class="item-image" onerror="this.src='images/1.png'">
      <div class="item-details">
        <div class="item-name">${item.name}</div>
        <div class="item-info">Количество: ${item.quantity} × ${item.price} ₽</div>
      </div>
    </div>
  `).join('');

  // Расчёт сумм
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const discount = Math.round(subtotal * 0.1);
  const total = subtotal - discount;

  updateSummary(subtotal, discount, total);
}

function updateSummary(subtotal, discount, total) {
  document.getElementById('subtotal').textContent = `${subtotal} ₽`;
  document.getElementById('discount').textContent = `${discount} ₽`;
  document.getElementById('total').textContent = `${total} ₽`;
}

/* ================= FORM SUBMISSION ================= */
document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const cart = JSON.parse(localStorage.getItem('cart') || '[]');

  if (cart.length === 0) {
    alert('Ваша корзина пуста!');
    return;
  }

  const token = localStorage.getItem('token');

  if (!token) {
    alert('Необходимо войти в систему для оформления заказа');
    window.location.href = 'login.html';
    return;
  }

  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const discount = Math.round(subtotal * 0.1);
  const total = subtotal - discount;

  const orderData = {
    cart: cart,
    user_data: {
      name: document.getElementById('fullName').value,
      city: document.getElementById('city').value,
      email: document.getElementById('email').value,
      address: document.getElementById('address').value,
      phone: document.getElementById('phone').value,
      postal_code: document.getElementById('zipCode').value
    }
  };

  try {
    const response = await fetch('http://localhost:5000/api/orders', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(orderData)
    });

    if (!response.ok) {
      const error = await response.json();
      alert('Ошибка при создании заказа: ' + (error.error || 'Неизвестная ошибка'));
      return;
    }

    // Очищаем корзину
    localStorage.removeItem('cart');

    // Показываем сообщение об успехе
    document.getElementById('successMessage').classList.add('show');

    // Скрываем форму
    this.style.display = 'none';

    // Обновляем отображение заказа
    setTimeout(() => {
      loadCart();
    }, 100);

  } catch (err) {
    alert('Ошибка подключения к серверу: ' + err.message);
  }
});

/* ================= INIT ================= */
window.addEventListener('DOMContentLoaded', loadCart);
</script>

</body>
</html>
